<!DOCTYPE html>
<!-- FIXME: wordwrap and max lines... -->
<html>
  <head>
    <meta charset="utf-8" />
    <title>calendar test</title>
    <style type="text/css">
      body {
        background: none transparent;
        font-family: Arial, Helvetica, Bitstream Vera Sans, sans-serif; 
        font-size: 15pt;
        width: 880px;
        height: 820px;
        overflow: hidden;
      }
      div.widget {
        border: 2px solid red;
      }
    </style>
  </head>
  <body>
    <table id='events'></table>
    <script>
      var apiKey = 'AIzaSyCJMQsUg3u-O0IcmdGVfomuQTa_G4Mk2Nc';
      var calIdList = ['amac.cranfield@googlemail.com', 
                       'p2t1d9qvbg69lq59klqng5dc6s@group.calendar.google.com',
                       'ls6tjllu1ko99fl9j3vm1kpmio@group.calendar.google.com',
                       'e85187a6fn6jc818bp9mphgpmk@group.calendar.google.com',
                       'hhn8pbbqdhur0r7pq1vh1m31m8@group.calendar.google.com'];
      //               '6ciph13spq4rmq28shlai1s83s@group.calendar.google.com'];
      var ignoreTitleList = ['seminar slot', 'to be decided', 'tbd'];
      var maxMsInFuture = 7*24*60*60*1000;
      var maxResults = 10;
      var dataRefreshMs = 10*60*1000;
      var layoutRefreshMs = 30*1000;
      var summaryMaxLength = 40;
      var locationMaxLength = 50;
      var maxLines = 24;
      
      var eventsElement = document.getElementById('events');
      var eventList = new Array();

      function Event(item) {
        this.summary = item.summary;
        if (item.location) {
          this.location = item.location;
        }
        if (item.start.dateTime) {
            this.startDateTime = new Date(item.start.dateTime);
            this.showStartTime = true;
        } else if (item.start.date) {
            this.startDateTime = new Date(item.start.date);
            this.showStartTime = false;
        }
        if (item.end.dateTime) {
            this.endDateTime = new Date(item.end.dateTime)
            this.showEndTime = true;
        } else if (item.end.date) {
            this.endDateTime = new Date(item.end.date);
            this.showEndTime = false;
        }
      }
      Event.prototype.toString = function() {
        var retval = this.startDateTime.getTime();
        retval += ' ' + this.endDateTime.getTime();
        retval += ' ' + this.summary;
        if(this.location) {
          retval += ' ' + this.location;
        }
        return retval;
      };

      function compareEvents(a, b) {

        if (a.startDateTime < b.startDateTime) {
            return -1;
        } else if (a.startDateTime > b.startDateTime) {
            return 1;
        }

        if (a.endDateTime < b.endDateTime) {
            return -1;
        } else if (a.endDateTime > b.endDateTime) {
            return 1;
        }

        if (a.summary < b.summary) {
            return -1;
        } else if (a.summary > b.summary) {
            return 1;
        }

        return 0;
      }

      function updateEventList(newEventList) {
        var updatedEventList = new Array();
        var now = new Date();
        var i = 0, j = 0;
        while (i < eventList.length && j < newEventList.length) {
          while(i < eventList.length && eventList[i].endDateTime < now) i++;
          if (i >= eventList.length) break;
          compVal = compareEvents(eventList[i], newEventList[j]);
          if (-1 == compVal) {
            updatedEventList.push(eventList[i++]);
          } else if (1 == compVal) { 
            updatedEventList.push(newEventList[j++]);
          } else {
            updatedEventList.push(eventList[i++]);
            j++;
          }
        }
        while (i < eventList.length) {
          updatedEventList.push(eventList[i++]);
        }
        while (j < newEventList.length) {
          updatedEventList.push(newEventList[j++]);
        }
        eventList = updatedEventList;
      }

      function dateFormat(dateTime) {
        var months = [ "January", "February", "March", "April", "May", "June",
                       "July", "August", "September", "October", "November",
                       "December" ];
        var retval = dateTime.getDate() + ' ' + months[dateTime.getMonth()];
        retval += ' ' + dateTime.getFullYear();
        return retval;
      }

      function timeFormat(dateTime) {
        var hours = dateTime.getHours();
        var minutes = dateTime.getMinutes();
        var ampm = (hours < 12) ? "am" : "pm";

        if (0 == hours) {
          hours = 12;
        } else if (hours > 12) {
          hours -= 12
        }

        if (minutes < 10) {
          minutes = '0' + minutes
        }

        return hours + ':' + minutes + ampm;
      }

      function layoutEventList() {
        var now = new Date();

        // clear out element
        while (eventsElement.firstChild) {
          eventsElement.removeChild(eventsElement.firstChild);
        }

        // insert events
        var prevStartDateString = '';
        var prevEndDateString = '';     
    
        for(var i = 0; i < eventList.length; i++) {
          var e = eventList[i];
          var row = document.createElement('tr');
          var startDateString = dateFormat(e.startDateTime);
          var endDateString = dateFormat(new Date(e.endDateTime.getTime() - 1));

          if (startDateString != prevStartDateString) {
            var dateCell = document.createElement('td');
            dateCell.setAttribute('colspan', 4);
            var dateTextString = startDateString;
            if (startDateString != endDateString) {
              dateTextString += ' - ' + endDateString;
            }
            //var dateText = document.createTextNode(dateTextString);
            //dateCell.appendChild(dateText)
            dateCell.innerHTML = dateTextString.bold();
            row.appendChild(dateCell);
            eventsElement.appendChild(row);
            row = document.createElement('tr');
            prevStartDateString = startDateString;
            prevEndDateString = endDateString;
          }

          if (e.startDateTime <= now && now <= e.endDateTime) {
            row.setAttribute('style', 'color: red;');
          }

          var startCell = document.createElement('td');
          startCell.setAttribute('style', 
            'padding: 0 5px 1px 0; vertical-align: top; text-align: right;');
          if (e.showStartTime) {
            var startText = 
              document.createTextNode(timeFormat(e.startDateTime));
            startCell.appendChild(startText);
          }
          row.appendChild(startCell);
          var endCell = document.createElement('td');
          endCell.setAttribute('style', 
            'padding: 0 5px 1px 0; vertical-align: top; text-align: right;');
          if (e.showEndTime) {
            var endText = document.createTextNode(timeFormat(e.endDateTime));
            endCell.appendChild(endText);
          }
          row.appendChild(endCell);
          var summaryCell = document.createElement('td');
          summaryCell.setAttribute('style', 
            'padding: 0 5px 1px 0; vertical-align: top;');
          var summaryText = document.createTextNode(e.summary)
          summaryCell.appendChild(summaryText);
          row.appendChild(summaryCell);
          var locationCell = document.createElement('td'); 
          locationCell.setAttribute('style', 
            'padding: 0 5px 1px 0; vertical-align: top;');
          if (e.location) {
            var locationText = document.createTextNode(e.location);
            locationCell.appendChild(locationText);
          }
          row.appendChild(locationCell);
          eventsElement.appendChild(row);
        }

      }

      function getCalEvents(calId) {
        var now = new Date();
        var timeMax = new Date(now.getTime() + maxMsInFuture);
        var request = gapi.client.calendar.events.list({
            'calendarId': calId,
            'singleEvents': 'true',
            'timeMin': now,
            'timeMax': timeMax,
            'maxResults': maxResults,
            'orderBy': 'startTime'
        });
        request.execute(function(response) {
          var newEventList = new Array();
          for (var i = 0; i < response.items.length; i++) {
              var item = response.items[i];
              if (ignoreTitleList.indexOf(item.summary.toLowerCase()) < 0) {
                newEventList.push(new Event(item));
              }
          }
          newEventList.sort(compareEvents);
          updateEventList(newEventList);
          layoutEventList();
        });
      }

      function loadCalendars() {
        gapi.client.load('calendar', 'v3', function() {
          for(var i = 0; i < calIdList.length; i++) {
            getCalEvents(calIdList[i]);
          }
        });
      }

      function handleClientLoad() {
        gapi.client.setApiKey(apiKey);
        loadCalendars();
        setInterval(loadCalendars, 10*60*1000);
        setInterval(layoutEventList, 60*1000);
      }

    </script>
    <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  </body>
</html>
