<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>calendar test</title>
  </head>
  <body>
    <div id='content'>
      <h1>Events</h1>
      <ul id='events'></ul>
    </div>
    <script>
      var apiKey = 'AIzaSyCJMQsUg3u-O0IcmdGVfomuQTa_G4Mk2Nc';
      var calIdList = ['amac.cranfield@googlemail.com', 
                       'p2t1d9qvbg69lq59klqng5dc6s@group.calendar.google.com',
                       'ls6tjllu1ko99fl9j3vm1kpmio@group.calendar.google.com',
                       'e85187a6fn6jc818bp9mphgpmk@group.calendar.google.com',
                       'hhn8pbbqdhur0r7pq1vh1m31m8@group.calendar.google.com',
                       '6ciph13spq4rmq28shlai1s83s@group.calendar.google.com'];
      var ignoreTitleList = ['seminar slot', 'to be decided', 'tbd'];
      var maxMsInFuture = 7*24*60*60*1000;
      var maxResults = 10;
      
      var eventsElement = document.getElementById('events');
      var eventList = new Array();

      function Event(item) {
        this.summary = item.summary;
        if (item.location) {
          this.location = item.location;
        }
        if (item.start.dateTime) {
            this.startDateTime = new Date(item.start.dateTime);
            this.showStartTime = true;
        } else if (item.start.date) {
            this.startDateTime = new Date(item.start.date);
            this.showStartTime = false;
        }
        if (item.end.dateTime) {
            this.endDateTime = new Date(item.end.dateTime)
            this.showEndTime = true;
        } else if (item.end.date) {
            this.endDateTime = new Date(item.end.date);
            this.showEndTime = false;
        }
      }
      Event.prototype.toString = function() {
        var retval = this.startDateTime.getTime();
        retval += ' ' + this.endDateTime.getTime();
        retval += ' ' + this.summary;
        if(this.location) {
          retval += ' ' + this.location;
        }
        return retval;
      };

      function compareEvents(a, b) {

        if (a.startDateTime < b.startDateTime) {
            return -1;
        } else if (a.startDateTime > b.startDateTime) {
            return 1;
        }

        if (a.endDateTime < b.endDateTime) {
            return -1;
        } else if (a.endDateTime > b.endDateTime) {
            return 1;
        }

        if (a.summary < b.summary) {
            return -1;
        } else if (a.summary > b.summary) {
            return 1;
        }

        return 0;
      }

      function updateEventList(newEventList) {
        var updatedEventList = new Array();
        var now = new Date();
        var i = 0, j = 0;
        while (i < eventList.length && j < newEventList.length) {
          while(i < eventList.length && eventList[i].endDateTime < now) i++;
          if (i >= eventList.length) break;
          compVal = compareEvents(eventList[i], newEventList[j]);
          if (-1 == compVal) {
            updatedEventList.push(eventList[i++]);
          } else if (1 == compVal) { 
            updatedEventList.push(newEventList[j++]);
          } else {
            updatedEventList.push(eventList[i++]);
            j++;
          }
        }
        while (i < eventList.length) {
          updatedEventList.push(eventList[i++]);
        }
        while (j < newEventList.length) {
          updatedEventList.push(newEventList[j++]);
        }
        eventList = updatedEventList;
      }

      function layoutEventList() {

        // clear out element
        while (eventsElement.firstChild) {
          eventsElement.removeChild(eventsElement.firstChild);
        }

        // insert events
        for(var i = 0; i < eventList.length; i++) {
          var li = document.createElement('li');
          li.appendChild(document.createTextNode(eventList[i].toString()));
          document.getElementById('events').appendChild(li);
        }

      }

      function getCalEvents(calId, now) {
        var timeMax = new Date(now.getTime() + maxMsInFuture);
        var request = gapi.client.calendar.events.list({
            'calendarId': calId,
            'singleEvents': 'true',
            'timeMin': now,
            'timeMax': timeMax,
            'maxResults': maxResults,
            'orderBy': 'startTime'
        });
        request.execute(function(response) {
          var newEventList = new Array();
          for (var i = 0; i < response.items.length; i++) {
              var item = response.items[i];
              if (ignoreTitleList.indexOf(item.summary.toLowerCase()) < 0) {
                newEventList.push(new Event(item));
              }
          }
          newEventList.sort(compareEvents);
          updateEventList(newEventList);
          layoutEventList();
        });
      }

      function loadCalendars() {
        var now = new Date();
        for(var i = 0; i < calIdList.length; i++) {
          getCalEvents(calIdList[i], now);
        }
      }

      function handleClientLoad() {
        var now = new Date();
        gapi.client.setApiKey(apiKey);
        gapi.client.load('calendar', 'v3', loadCalendars);
      }
    </script>
    <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  </body>
</html>
