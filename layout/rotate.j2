{%- macro rotate(pagesets, pages, seconds, allowrepeat=false, width, height, left, top, name='', class='map') -%}
  <iframe id="rotate_{{ name }}_0" class="rotate" src="" style="
    position: absolute; width: {{ width }}; height: {{ height }}; top: {{ top }}; left: {{ left }}; border: 0; overflow: hidden;" 
    onload="$('#rotate_{{ name }}_0').hide();">{{ caller() }}</iframe>
  <iframe id="rotate_{{ name }}_1" class="rotate" src="" style="
    position: absolute; width: {{ width }}; height: {{ height }}; top: {{ top }}; left: {{ left }}; border: 0; overflow: hidden;" 
    onload="$('#rotate_{{ name }}_1').hide();">{{ caller() }}</iframe>
  <script type="text/javascript">
  <!--
  rotateUrls_{{ name }} = new Array();
  <?php 
      $rotateUrls = array(); 
      {% for pageset in pagesets %}
          $response = file_get_contents("{{ pageset }}");
          $url_list = preg_split('/\s+/', trim($response));
          foreach($url_list as $url) {
              $rotateUrls[] = $url;
          }
      {% endfor %}
      {% for page in pages %}
          $rotateUrls[] = "{{ page }}";
      {% endfor %}
      foreach($rotateUrls as $url) {
          echo "rotateUrls_{{ name }}.push(\"" . $url . "\")\n";
      }
  ?>
  rotateUrlIndex_{{ name }} = Math.floor(Math.random() * rotateUrls_{{ name }}.length);
  $('#rotate_{{ name }}_0').hide();
  $('#rotate_{{ name }}_0').attr('src', rotateUrls_{{ name }}[rotateUrlIndex_{{ name }}]);
  var rotateFrameIndex_{{ name }} = 0;
  function rotateContent_{{ name }}() {
      {% if allowrepeat %}
      rotateUrlIndex_{{ name }} = (rotateUrlIndex_{{ name }} +
                        Math.floor(Math.random() * (rotateUrls_{{ name }}.length))
                       ) % rotateUrls_{{ name }}.length;
      {% else %}
      rotateUrlIndex_{{ name }} = (rotateUrlIndex_{{ name }} + 1 + 
                        Math.floor(Math.random() * (rotateUrls_{{ name }}.length - 1))
                       ) % rotateUrls_{{ name }}.length;
      {% endif %}
      otherFrameIndex = (rotateFrameIndex_{{ name }} + 1) % 2;
      $('#rotate_{{ name }}_' + otherFrameIndex).css('z-index', 0);
      $('#rotate_{{ name }}_' + rotateFrameIndex_{{ name }}).css('z-index', 1);
      document.getElementById('rotate_{{ name }}_' + rotateFrameIndex_{{ name }}).contentWindow.postMessage('start', '*');
      $('#rotate_{{ name }}_' + rotateFrameIndex_{{ name }}).fadeIn(1000, function () {
          $('#rotate_{{ name }}_' + otherFrameIndex).hide();
          $('#rotate_{{ name }}_' + otherFrameIndex).attr('src', rotateUrls_{{ name }}[rotateUrlIndex_{{ name }}]);
          rotateFrameIndex_{{ name }} = otherFrameIndex;
      });
  } 
  setTimeout(function () {
      rotateContent_{{ name }}();
      setInterval(rotateContent_{{ name }}, {{ seconds }} * 1000);
  } , 2000);
  //-->
  </script>
{%- endmacro -%}
