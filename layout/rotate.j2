{%- macro rotate(pagesets, pages, seconds, allowrepeat=false, width, height, left, top, name='') -%}
  {% for index in range(2) %}
    <iframe id="rotate_{{ name }}_{{ index }}" class="rotate" src="" style="
        position: absolute; width: {{ width }}; height: {{ height }};
        top: {{ top }}; left: {{ left }}; border: 0; overflow: hidden;"
        onload="$('this').hide();">{{ caller() }}</iframe>
  {% endfor %}
  <script type="text/javascript">
  <!--
  rotateUrls_{{ name }} = new Array();
  <?php 
      $rotateUrls = array(); 
      {% for pageset in pagesets %}
          $response = file_get_contents("{{ pageset }}");
          $url_list = preg_split('/\s+/', trim($response));
          foreach($url_list as $url) {
              $rotateUrls[] = $url;
          }
      {% endfor %}
      {% for page in pages %}
          $rotateUrls[] = "{{ page }}";
      {% endfor %}
      foreach($rotateUrls as $url) {
          echo "rotateUrls_{{ name }}.push(\"" . $url . "\")\n";
      }
  ?>
  var rotateUrlIndex_{{ name }} = Math.floor(Math.random() * 
                                             rotateUrls_{{ name }}.length);
  var rotateFrameIndex_{{ name }} = 0;
  function loadFrame_{{ name }} () {
    $('#rotate_{{ name }}_' + rotateFrameIndex).hide();
    $('#rotate_{{ name }}_' + rotateFrameIndex).attr('src', 
        rotateUrls_{{ name }}[rotateUrlIndex_{{ name }}] + '?now=' + (new Date()).getTime());

  function rotateContent_{{ name }}() {
      rotateUrlIndex_{{ name }} = (rotateUrlIndex_{{ name }} + 1 + 
                        Math.floor(Math.random() * (rotateUrls_{{ name }}.length - 1))
                       ) % rotateUrls_{{ name }}.length;
      otherFrameIndex = (rotateFrameIndex_{{ name }} + 1) % 2;
      $('#rotate_{{ name }}_' + otherFrameIndex).css('z-index', 0);
      $('#rotate_{{ name }}_' + rotateFrameIndex_{{ name }}).css('z-index', 1);
      document.getElementById('rotate_{{ name }}_' + rotateFrameIndex_{{ name }}).contentWindow.postMessage('start', '*');
      $('#rotate_{{ name }}_' + rotateFrameIndex_{{ name }}).fadeIn(1000, function () {
          $('#rotate_{{ name }}_' + otherFrameIndex).hide();
          $('#rotate_{{ name }}_' + otherFrameIndex).attr('src', rotateUrls_{{ name }}[rotateUrlIndex_{{ name }}]);
          rotateFrameIndex_{{ name }} = otherFrameIndex;
      });
  } 
  setTimeout(function () {
      rotateContent_{{ name }}();
      setInterval(rotateContent_{{ name }}, {{ seconds }} * 1000);
  } , 2000);
  //-->
  </script>
{%- endmacro -%}
